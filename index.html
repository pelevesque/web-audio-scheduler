<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Audio Scheduler</title>
</head>
<body>
  <button id="audio_on">audio on</button> <!-- AudioContext must be started by a user generated event. -->
  <button id="start">start</button>
  <button id="stop">stop</button>
  <script>

    /***************************************************************************
    * AudioScheduler
    *
    * Sends timed events to a callback using precise timing.
    * @inspired by https://www.html5rocks.com/en/tutorials/audio/scheduling
    *
    * Javascript's setTimeout is used to create a recursive loop in which
    * events are scheduled for the web audio clock. As often as indicated by
    * the scheduleInterval variable, events are scheduled as far into the
    * future as the scheduleLookahead variable.
    *
    * This dual clock system (Javascript's setTimeout clock + web audio clock),
    * permits us to change the tempo and add events anytime during play back.
    *
    * TO DO
    * - pause
    * - add events during playback
    ***************************************************************************/
    const AudioScheduler = function (audioContext, {
      scheduleInterval =  50, // in milliseconds
      scheduleLookahead = 100, // in milliseconds
      events = [],
      callback = function(){}
    } = {} ) {
      this.audioContext = audioContext
      this.scheduleInterval = scheduleInterval // schedule new events at this interval
      this.scheduleLookahead = scheduleLookahead // schedule new events this far into the future
      this.events = events // an events object that must at least contain the time property for each event
      this.callback = callback // a function used to play the events
      this.eventsIndexNeedle // a needle used to go through the events index by index
      this.timerID // used by clearTimeout() to identify the setTimeout timer
      this.startTimeOffset // the offset between the time at audioContext creation and audioContext.currentTime
    }

    AudioScheduler.prototype.stop = function() {
      clearTimeout(this.timerID)
    }

    AudioScheduler.prototype.reset = function() {
      this.eventsIndexNeedle = 0
      this.timerID = null
      this.startTimeOffset = this.audioContext.currentTime
    }

    AudioScheduler.prototype.start = function() {
      this.stop()
      this.reset()
      if (this.events.length > 0) {
        this.play()
      }
    }

    AudioScheduler.prototype.play = function() {
      console.log(this.scheduleInterval) // when this is removed, the error happens right away
      // we need a way to break the loop
      while(
        this.eventsIndexNeedle < this.events.length &&
        (this.events[this.eventsIndexNeedle].time + this.startTimeOffset <
        this.audioContext.currentTime + (this.scheduleLookahead / 1000))
      ) {
        this.callback(this.events[this.eventsIndexNeedle])
        this.eventsIndexNeedle++
      }
      this.timerID = setTimeout(this.play(), this.scheduleInterval)
    }

    /***************************************************************************
    * AudioScheduler END
    ***************************************************************************/

    document.addEventListener('DOMContentLoaded', function() {

      let  scheduler

      // Turn AudioContext() on with a user generated event.
      document.getElementById('audio_on').onclick = function() {
        let audioContext = new AudioContext()

        const events = [
          { time: 2, data: 200 },
          { time: 4, data: 400 },
          { time: 6, data: 600 },
          { time: 8, data: 800 }
        ]

        function callback(e) {
          const osc = audioContext.createOscillator()
          osc.frequency.value = e.data
          osc.connect(audioContext.destination)
          osc.start(e.time)
          osc.stop(e.time + 1)
        }

        scheduler = new AudioScheduler(audioContext, {
          events: events,
          callback: callback
        })
      }

      document.getElementById('start').onclick = function() {
        scheduler.start()
      }

      document.getElementById('stop').onclick = function() {
        scheduler.stop()
      }

    })
  </script>
</body>
</html>
